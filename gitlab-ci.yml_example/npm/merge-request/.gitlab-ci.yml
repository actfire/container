# TODO: é™å®š main åˆ†æ”¯
# TODO: å¿…é ˆæ˜¯è¦æ˜¯ after merge request é€šéå¾Œ
# TODO: æˆåŠŸæˆ–å¤±æ•— è·‘å‰¯ç¨‹å¼(é€šçŸ¥)

default:
  image: node:16.20.2
  tags:
    - docker
  # cache:
  #   key:
  #     files:
  #       - pnpm-lock.yaml
  #   paths:
  #     - .pnpm-store
  #   policy: pull
  # before_script:
  #   - corepack enable
  #   - corepack prepare pnpm@latest-8 --activate
  #   - pnpm config set store-dir .pnpm-store

# å®˜æ–¹é»˜èªé å®šç¾©çš„5å€‹éšæ®µï¼ˆæŒ‰é †åºï¼‰ï¼š.preã€buildã€testã€deployã€.post
stages:
  - build
  - test

# global variable
variables:
  TEST_VAR: 'Hello World!'


# å¦‚æœæ‚¨æƒ³åœ¨å»ºç«‹åˆä½µè«‹æ±‚æ™‚ä»¥åŠåˆä½µåˆ°ä¸»åˆ†æ”¯å¾Œé‹è¡Œç®¡é“
workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    # - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE == "push"

# å¯å¾©ç”¨çš„ä»»å‹™
.notify_sh:
  after_script:
    - echo 'send notify ğŸ”¥ğŸ”¥ğŸ”¥'

pre-job:
  stage: .pre
  script:
    - |
      echo ======================= all env ===============================
      env

job_build:
  # extends: .notify_sh
  stage: build
  only:
    - main
  cache:
    key:
      files:
        - package-lock.json
      prefix: npm
    paths:
      - node_modules/
    policy: pull
  script:
    - |
      npm i
      npm run build
  artifacts:
    paths:
      - dist
    expire_in: 30 mins

job_on_success:
  stage: test
  only:
    - main
  needs: ["job_build"]
  when: on_success
  script:
    - echo 'success!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!'

job_on_fail:
  stage: test
  only:
    - main
  needs: ["job_build"]
  when: on_failure
  script:
    - echo 'fail !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!'

last-job:
  stage: .post
  script:
    - echo "This job runs in the .post stage, after all other stages."

# CI è®Šæ•¸èªªæ˜
# https://docs.gitlab.cn/jh/ci/variables/predefined_variables.html
# CI è®Šæ•¸é‡é» CI_MERGE_REQUEST_EVENT_TYPE 